# GitHub Actions Workflow: Packer checks
# Runs on `push`, pull requests, and created releases.
# For pull requests and checks the following steps are executed:
# - Checkout: the repository is checked out.
# - Setup Packer: `hashicorp/setup-packer` installs Packer on the runner.
# In the `packer` working directory the following commands are executed to validate templates:
# - `packer init`        -> initializes any modules or plugin requirements
# - `packer fmt -check`  -> checks that Packer templates are properly formatted
# - `packer validate`    -> validates the Packer template(s)

name: 'Packer'

env:
  PACKER_VERSION: '1.10.0'

on:
  push:
  pull_request:
    branches: [ "main" ]
  release:
    types: [created]

permissions:
  contents: read

jobs:
  packer:
    name: 'Packer'
    runs-on: ubuntu-latest
    environment: production

    defaults:
      run:
        shell: bash

    steps:
    - name: Checkout
      uses: actions/checkout@v4

    - name: Debug workspace
      run: |
        pwd
        ls -la
        ls -la packer || echo "packer directory not found"
        git rev-parse --abbrev-ref HEAD || true
        git log -1 --oneline || true

    - name: Setup `packer` (local action)
      uses: ./.github/actions
      id: setup_packer
      with:
        version: '1.14.3'

    - name: Print `$PATH` for `packer`
      run: which packer

    - name: Print `packer` version
      run: packer version

    - name: Packer Init
      run: packer init packer

    - name: Packer Format
      run: packer fmt -check packer